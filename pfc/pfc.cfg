# Include configuration files for menu, tools, and loading functionality
[include pfc_menu.cfg]
[include pfc_tools.cfg]
[include pfc_loading.cfg]

# MCU configuration for PFC board (STM32F103XE)
[mcu pfc_board]
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_PCF-if00


################################
#
#  PARAMETER TO ADAPT TO YOUR SETUP
#
################################

# Global variables for PFC (Palette Filament Changer) system configuration
[gcode_macro VAR_pfc]
# Timeout duration for pause operations (in seconds) - 1 hour default
variable_timeout_pause: 36000 #1h
# Time to disable heater after pause (in seconds)
variable_disable_heater: 600
# Length to retract filament from extruder in mm (unloading distance)
variable_bowden_length: 100
# Number of available tools/filament slots
variable_tools: 4
# Minimum temperature required for extruder operations
variable_min_temp_extruder: 180
# Temperature for ejecting filament during tool change
variable_extruder_eject_temp: 200
# Rotation distance for extruder stepper motor
variable_rotarion_distance: 31.7567
# Default extruder temperature
variable_extruder_temp:200
# X coordinate for tool change position (optimal location for purge/wipe tower)
variable_x_home:235
# Y coordinate for tool change position (optimal location for purge/wipe tower)
variable_y_home:300
# Z offset to lift before tool change (in mm)
variable_z_up_home:2
# Current status message
variable_status:'"Status init"'
# Enable/disable filament sensor (1=enabled, 0=disabled)
variable_filament_sensor_enabled: 1
gcode:

# Initialization macro that runs on printer startup
# Restores previously selected tool and pressure advance settings
[delayed_gcode start]
initial_duration: 1.0
gcode:
  # Load saved variables from previous session
  {% set svv = printer.save_variables.variables %}
  {% set selected = svv.pfc_selected_tool|int|default(0) %}
  {% set pressure_advance = svv.pressure_advance|default(0) %}

  # Display initial state information
  {action_respond_info("Initial selected tool is = %i \n" % (selected))}
  {action_respond_info("Initial pressure advance is = %i \n" % (pressure_advance))}
  # Restore tool selection
  SELECT_TOOL VALUE={selected}
  # Restore pressure advance setting
  SET_PRESSURE_ADVANCE ADVANCE={pressure_advance}
  # If extruder was heating, restore temperature
  {% if printer.extruder.target > 100.0 %}
    M104 S200
  {% endif %}
  