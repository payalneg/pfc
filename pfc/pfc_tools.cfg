# Include individual tool configuration files
[include pfc_tool_0.cfg]
[include pfc_tool_1.cfg]
[include pfc_tool_2.cfg]
[include pfc_tool_3.cfg]

# Legacy filament motion sensor configuration (commented out)
#[filament_motion_sensor filament_motion_sensor]
#detection_length: 15.0
#extruder: extruder
#switch_pin: pfc_board:PB15
#pause_on_runout: True
#runout_gcode:
    #M118 Filament runout
    #SET_GCODE_VARIABLE MACRO=VAR_PCF VARIABLE=extruder_temp VALUE={printer.extruder.temperature}
    #SET_IDLE_TIMEOUT TIMEOUT={printer["gcode_macro VAR_PCF"].timeout_pause}
    #PAUSE
    #M109 S{printer["gcode_macro VAR_PCF"].extruder_temp}
    #PAUSE_PCF
#insert_gcode:
    #SET_IDLE_TIMEOUT TIMEOUT=600

# Enable filament motion sensor for currently selected tool
# Only enables if a tool is selected and sensor is enabled in settings
[gcode_macro ENABLE_FILAMENT_MOTION_SENSOR]
gcode:
  {% if printer["gcode_macro SELECT_TOOL"].tool_selected|int != -1 %}
    {% if printer["gcode_macro VAR_pfc"].filament_sensor_enabled|int == 1%}
      SET_FILAMENT_SENSOR SENSOR=filament_motion_sensor_t{printer["gcode_macro SELECT_TOOL"].tool_selected|int} ENABLE=1
    {% endif %}
  {% endif %}
  
# Select a tool - activates the specified tool's stepper motor and syncs it with extruder
[gcode_macro SELECT_TOOL]
variable_tool_selected: 0
gcode:
    # Wait for all moves to complete
    M400
    #{action_respond_info(printer["gcode_button T%i_button" % params.VALUE|int].state)}
    # Check if tool button is pressed (tool is physically connected)
    {% if printer["gcode_button T%i_button" % params.VALUE|int].state == "PRESSED" %}
      {action_respond_info("Changing to Tool %i" % (params.VALUE|int))}
      # Update selected tool variable
      SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=tool_selected VALUE={params.VALUE}
      # Save tool selection to persistent storage
      SAVE_VARIABLE VARIABLE=pfc_selected_tool VALUE={params.VALUE|int}
      # Configure all tools - enable selected, disable others
      {% for i in range(printer["gcode_macro VAR_pfc"].tools) %}
          {% if i == params.VALUE|int %}
              # Enable filament sensor for selected tool
              FILAMENT_MOTION_SENSOR_DELAY SENSOR=filament_motion_sensor_t{i} DELAY=1             
              # Sync this tool's stepper with main extruder motion queue
              SYNC_EXTRUDER_MOTION Extruder=filament{i}_e Motion_queue=extruder
              # Enable stepper driver (TOFF=1 means driver enabled)
              SET_TMC_FIELD STEPPER=filament{i}_e FIELD=TOFF VALUE=1
              # Reset filament sensor
              FILAMENT_MOTION_SENSOR_RESET SENSOR=filament_motion_sensor_t{i}      
          {% else %}
              # Disconnect other tools from motion queue
              SYNC_EXTRUDER_MOTION Extruder=filament{i}_e Motion_queue=
              # Disable stepper driver (TOFF=0 means driver disabled)
              SET_TMC_FIELD STEPPER=filament{i}_e FIELD=TOFF VALUE=0
          {% endif %}
      {% endfor %}
      # Restore pressure advance for selected tool
      RESTORE_PRESSURE_ADVANCE
    {% else %}
      {action_respond_info("Tool %i unavailable" % (params.VALUE|int))}
    {% endif %}
    
# Display currently selected tool number
[gcode_macro TOOL_SELECTED]
gcode:
    {action_respond_info("Selected tool is = %i \n" % (printer["gcode_macro SELECT_TOOL"].tool_selected|int))}

# Tool -1 configuration (no tool selected state, use only main extruder, filament sensor disabled)
[gcode_macro T-1]
variable_pa:0.04
gcode:    

# Button for detecting when no tool is connected
[gcode_button T-1_button]
pin: ^pfc_board:PA13
press_gcode:

# Tool Replace macro - unloads current tool and loads new tool
[gcode_macro TR]
gcode:
    # Set relative extrusion mode
    M83
	M400
    # Check if a tool is currently selected
    {% if printer["gcode_macro SELECT_TOOL"].tool_selected|int != -1 %}
    	# Check if tool change is needed
    	{% if printer["gcode_macro SELECT_TOOL"].tool_selected|int != params.VALUE|int %}
            # Home printer if not already homed
            {% if printer.toolhead.homed_axes != "xyz" %}
              G28
              G91
              G1 Z{printer["gcode_macro VAR_pfc"].z_up_home} F500
              G90
              G1 X{printer["gcode_macro VAR_pfc"].x_home} Y{printer["gcode_macro VAR_pfc"].y_home} F5000
            {% endif %}
            
            # Heat extruder to ejection temperature (or specified temp)
            #M109 S{params.TEMP|int}
            #{% if printer.extruder.target < printer["gcode_macro VAR_pfc"].min_temp_extruder %}
            {% if 'TEMP' in params %}
                M109 S{params.TEMP|int}
            {% else %}
                M109 S{printer["gcode_macro VAR_pfc"].extruder_eject_temp}
            {% endif %}
            #{% endif %}
            # Unload current tool
            UT
            # Load new tool
            LT VALUE={params.VALUE|int}
            # Move to tool change position and purge filament
            G1 X{printer["gcode_macro VAR_pfc"].x_home} Y{printer["gcode_macro VAR_pfc"].y_home} Z1.5 F5000
            G1 X{printer["gcode_macro VAR_pfc"].x_home-200} Y{printer["gcode_macro VAR_pfc"].y_home} Z1.5 E200 F250
            #G1 E50 F250
            M400
        {% else %}
            {action_respond_info("Tool already selected selected")}
    	{% endif %}
    {% else %}
        {action_respond_info("No tool selected")}
  	{% endif %}

# Display pressure advance values for all tools
[gcode_macro SHOW_PRESSURE_ADVANCE]
gcode:
    {% for i in range(printer["gcode_macro VAR_pfc"].tools) %}
        {action_respond_info("Pressure advance T%i = %f \n" % (i, printer["gcode_macro T%i" % i].pa))}
    {% endfor %}

# Restore pressure advance setting for currently selected tool
[gcode_macro RESTORE_PRESSURE_ADVANCE]
gcode: 
    {% set temp = "gcode_macro T%i" % printer['gcode_macro SELECT_TOOL'].tool_selected|int %}
    SET_PRESSURE_ADVANCE ADVANCE={printer[temp].pa}


# Ensure extruder is heated before attempting to extrude
[gcode_macro HEAT_EXTRUDER_BEFORE_EXTRUDE]
gcode:
    {% if printer.extruder.temperature < printer["gcode_macro VAR_pfc"].min_temp_extruder %}
      SET_GCODE_VARIABLE MACRO=VAR_pfc VARIABLE=status VALUE='"Heating before extrude"'
      M109 S{printer["gcode_macro VAR_pfc"].extruder_eject_temp}
    {% endif %}


# Check filament patency (flow) for all tools by loading and unloading each
[gcode_macro CHECK_FILAMENT_PATENCY]
gcode:
    # Save current tool selection
    {% set last_tool = printer["gcode_macro SELECT_TOOL"].tool_selected %}
    # Test each tool
    {% for i in range(printer["gcode_macro VAR_pfc"].tools) %}
        SELECT_TOOL VALUE={i}
        LOAD_FILAMENT_TO_EXTRUDER
        UNLOAD_FILAMENT_FROM_EXTRUDER
    {% endfor %}
    # Restore original tool selection
    SELECT_TOOL VALUE={last_tool}

# Save current pressure advance value to tool's variable and persistent storage
[gcode_macro SAVE_CURRENT_PA]
gcode:
    SET_GCODE_VARIABLE MACRO=T{printer["gcode_macro SELECT_TOOL"].tool_selected} VARIABLE=pa VALUE={printer.extruder.pressure_advance}
    SAVE_VARIABLE VARIABLE=pa_t{printer["gcode_macro SELECT_TOOL"].tool_selected} VALUE={printer.extruder.pressure_advance}